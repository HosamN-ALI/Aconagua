// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [vector]
}

// ============================================
// AUTH MODULE - User Management
// ============================================

enum UserRole {
  STUDENT
  TEACHER
  ADMIN
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  firstName String
  lastName  String
  role      UserRole @default(STUDENT)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  studentProgress StudentProgress[]
  quizAttempts    QuizAttempt[]
  achievements    UserAchievement[]
  chatSessions    ChatSession[]

  @@map("users")
}

// ============================================
// CURRICULUM MODULE - Saudi Math Curriculum
// ============================================

model Subject {
  id          String   @id @default(uuid())
  name        String   @unique // "Mathematics"
  nameAr      String   @unique // "الرياضيات"
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  grades Grade[]

  @@map("subjects")
}

model Grade {
  id        String   @id @default(uuid())
  subjectId String
  level     Int      @unique // 1-12
  name      String // "Grade 1", "Grade 2"
  nameAr    String // "الصف الأول", "الصف الثاني"
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  subject  Subject   @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  chapters Chapter[]

  @@map("grades")
}

model Chapter {
  id          String   @id @default(uuid())
  gradeId     String
  orderIndex  Int // Order within grade
  title       String
  titleAr     String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  grade   Grade    @relation(fields: [gradeId], references: [id], onDelete: Cascade)
  lessons Lesson[]

  @@unique([gradeId, orderIndex])
  @@map("chapters")
}

model Lesson {
  id          String   @id @default(uuid())
  chapterId   String
  orderIndex  Int // Order within chapter
  title       String
  titleAr     String
  content     String   @db.Text // Lesson content in markdown
  contentAr   String   @db.Text
  objectives  String[] // Learning objectives
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  chapter          Chapter           @relation(fields: [chapterId], references: [id], onDelete: Cascade)
  problems         Problem[]
  lessonEmbeddings LessonEmbedding[]
  studentProgress  StudentProgress[]

  @@unique([chapterId, orderIndex])
  @@map("lessons")
}

model Problem {
  id           String   @id @default(uuid())
  lessonId     String
  orderIndex   Int
  question     String   @db.Text
  questionAr   String   @db.Text
  difficulty   Int      @default(1) // 1-5
  problemType  String // "multiple_choice", "open_ended", "true_false"
  imageUrl     String? // Optional image for the problem
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  lesson        Lesson         @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  solutions     Solution[]
  quizAttempts  QuizAttempt[]

  @@unique([lessonId, orderIndex])
  @@map("problems")
}

model Solution {
  id          String   @id @default(uuid())
  problemId   String
  content     String   @db.Text
  contentAr   String   @db.Text
  steps       String[] // Step-by-step solution
  isCorrect   Boolean  @default(true) // For multiple choice options
  explanation String?  @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  problem Problem @relation(fields: [problemId], references: [id], onDelete: Cascade)

  @@map("solutions")
}

// ============================================
// AI TUTOR MODULE - Embeddings & Context
// ============================================

model LessonEmbedding {
  id         String                     @id @default(uuid())
  lessonId   String
  content    String                     @db.Text // Chunk of lesson content
  embedding  Unsupported("vector(1536)") // OpenAI embedding dimension
  metadata   Json? // Additional metadata
  createdAt  DateTime                   @default(now())

  // Relations
  lesson Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@map("lesson_embeddings")
}

model ChatSession {
  id        String   @id @default(uuid())
  userId    String
  title     String   @default("New Chat")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user     User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages ChatMessage[]

  @@map("chat_sessions")
}

model ChatMessage {
  id            String   @id @default(uuid())
  sessionId     String
  role          String // "user", "assistant", "system"
  content       String   @db.Text
  imageUrl      String? // For OCR images
  metadata      Json? // Additional context
  createdAt     DateTime @default(now())

  // Relations
  session ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@map("chat_messages")
}

// ============================================
// LEARNING MODULE - Progress & Gamification
// ============================================

model StudentProgress {
  id               String   @id @default(uuid())
  userId           String
  lessonId         String
  status           String   @default("not_started") // "not_started", "in_progress", "completed"
  completionRate   Float    @default(0) // 0-100
  timeSpentMinutes Int      @default(0)
  lastAccessedAt   DateTime @default(now())
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  lesson Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([userId, lessonId])
  @@map("student_progress")
}

model QuizAttempt {
  id          String   @id @default(uuid())
  userId      String
  problemId   String
  answer      String   @db.Text
  isCorrect   Boolean
  score       Int      @default(0) // Points earned
  hintsUsed   Int      @default(0)
  timeSpent   Int // Seconds
  attemptedAt DateTime @default(now())

  // Relations
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  problem Problem @relation(fields: [problemId], references: [id], onDelete: Cascade)

  @@map("quiz_attempts")
}

model Achievement {
  id          String   @id @default(uuid())
  name        String   @unique
  nameAr      String
  description String
  iconUrl     String?
  points      Int      @default(0)
  criteria    Json // Conditions to unlock
  createdAt   DateTime @default(now())

  // Relations
  users UserAchievement[]

  @@map("achievements")
}

model UserAchievement {
  id            String   @id @default(uuid())
  userId        String
  achievementId String
  unlockedAt    DateTime @default(now())

  // Relations
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  achievement Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)

  @@unique([userId, achievementId])
  @@map("user_achievements")
}
